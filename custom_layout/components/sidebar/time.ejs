<div class="sidebar-widget custom-sidebar-widget">
  <div class="time-section">
    <div id="current-time" class="current-time"></div>
  </div>
  <div class="date-section">
    <div id="current-date" class="current-date"></div>
  </div>
  <div class="weather-section">
    <div id="current-weather" class="current-weather">åŠ è½½ä¸­...</div>
  </div>
  <div class="calendar-section">
    <div class="calendar-header">
      <button id="prev-month" class="calendar-nav-btn">&lt</button>
      <h3 id="calendar-month-year"></h3>
      <button id="next-month" class="calendar-nav-btn">&gt</button>
    </div>
    <div class="calendar-weekdays">
      <div>æ—¥</div>
      <div>ä¸€</div>
      <div>äºŒ</div>
      <div>ä¸‰</div>
      <div>å››</div>
      <div>äº”</div>
      <div>å…­</div>
    </div>
    <div id="calendar-dates" class="calendar-dates"></div>
  </div>
</div>

<style>
/* æ ¸å¿ƒæ ¹å®¹å™¨ */
.custom-sidebar-widget {
  padding: 10px;
  margin: 0;
  text-align: center;
  background-color: var(--body-bg);
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  border: 0px solid var(--border-color);
}

/* æ—¶é—´æ¨¡å— */
.time-section {
  margin-bottom: 2px;
}

.current-time {
  font-size: 1.8rem;
  font-weight: 600;
  color: var(--text-color);
  letter-spacing: 1px;
}

/* æ—¥æœŸæ¨¡å— */
.date-section {
  margin-bottom: 7px;
}

.current-date {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color);
}

/* å¤©æ°”æ¨¡å— */
.weather-section {
  margin-bottom: 5px;
  padding-bottom: 7px;
  border-bottom: 1px solid var(--border-color);
}

.current-weather {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color);
  line-height: 1.4;
  white-space: pre-line;
}

/* æ—¥å†æ ¹å®¹å™¨ */
.calendar-section {
  margin-top: 0;
}

/* æ—¥å†å¤´éƒ¨ */
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0;
}

/* æ—¥å†å¤´éƒ¨h3 */
.calendar-header h3 {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color);
  margin: 0;
}

/* æ—¥å†å¤´éƒ¨æŒ‰é’® */
.calendar-nav-btn {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-color);
  background: none;
  border: none;
  cursor: pointer;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.2s;
  transform: translateY(-1px);
}

.calendar-nav-btn:hover {
  background-color: var(--hover-bg);
}

/* æ—¥å†æ˜ŸæœŸæ  */
.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  margin-bottom: 0;
}

.calendar-weekdays div {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color);
  text-align: center;
  padding: 0;
}

/* æ—¥å†æ—¥æœŸæ  */
.calendar-dates {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0;
}

.calendar-dates div {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-color);
  text-align: center;
  padding: 0;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: default;
}

/* å…¶ä»–æœˆä»½æ—¥æœŸ */
.calendar-dates .other-month {
  color: var(--secondary-text-color);
  opacity: 0.8;
}

/* å½“å‰æœˆä»½æ—¥æœŸ */
.calendar-dates .current-month {
  color: var(--text-color);
}

/* ä»Šæ—¥æ—¥æœŸ */
.calendar-dates .today {
  color: white;
  background-color: var(--primary-color);
  box-shadow: 0 2px 5px rgba(var(--primary-color-rgb), 0.3);
}

.calendar-dates .date-item:hover:not(.today) {
  background-color: var(--hover-bg);
}

@media (prefers-color-scheme: dark) {
  .custom-sidebar-widget {
    color: var(--text-color, #e5e7eb);
  }
  .current-weather {
    color: var(--text-color);
  }
}

@media (max-width: 768px) {
  .current-time {
    font-size: 1.8rem;
  }
  .current-date {
    font-size: 0.9rem;
  }
  .current-weather {
    font-size: 0.9rem;
  }
}
</style>

<script>
function initCalendarWidget() {
  console.log('åˆå§‹åŒ–æ—¶é—´å¤©æ°”æ¨¡å—...');
  if (window.calendarWidgetInitialized && Date.now() - window.calendarWidgetInitialized < 1000) return;
  window.calendarWidgetInitialized = Date.now();
  
  if (window.calendarTimers) {
    window.calendarTimers.forEach(timer => clearInterval(timer));
    window.calendarTimers = [];
  } else {
    window.calendarTimers = [];
  }

  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
      timeElement.textContent = timeString;
    }
  }

  function updateDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const weekdayMap = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekday = weekdayMap[now.getDay()];
    const dateString = `${year}å¹´${month}æœˆ${day}æ—¥ã€€${weekday}`;
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
      dateElement.textContent = dateString;
    }
  }

  const API_URL = "https://v1.yiketianqi.com/free/day?appid=55974212&appsecret=eo5XbG53&unescape=1";

  const ICON_MAP = {
    "qing": "â˜€ï¸",
    "yun": "ğŸŒ¤ï¸",
    "yin": "â›…",
    "yu": "ğŸŒ§ï¸",
    "xiaoyu": "ğŸŒ¦ï¸",
    "zhongyu": "ğŸŒ§ï¸",
    "dayu": "ğŸŒ¨ï¸",
    "xue": "â„ï¸",
    "feng": "ğŸ’¨",
    "wu": "ğŸŒ«ï¸",
    "bing": "ğŸ§Š",
    "lei": "â›ˆï¸"
  };

  function getAirLevel(aqi) {
    aqi = Number(aqi);
    if (aqi <= 50) return "ä¼˜";
    if (aqi <= 100) return "è‰¯";
    if (aqi <= 150) return "è½»åº¦æ±¡æŸ“";
    if (aqi <= 200) return "ä¸­åº¦æ±¡æŸ“";
    if (aqi <= 300) return "é‡åº¦æ±¡æŸ“";
    return "ä¸¥é‡æ±¡æŸ“";
  }

  function renderWeather(data) {
    const weatherEl = document.getElementById("current-weather");
    if (!weatherEl) return;
    const tempStr = `${data.tem_night}â„ƒ ~ ${data.tem_day}â„ƒ`;
    const weatherText = `${data.city} ${ICON_MAP[data.wea_img] || "ğŸŒ¡ï¸"} ${data.wea}ã€€${tempStr}\nç©ºæ°”: ${getAirLevel(data.air)}ã€€${data.win} ${data.win_speed}`;
    weatherEl.textContent = weatherText;
  }

  function renderWeatherError(msg) {
    const weatherEl = document.getElementById("current-weather");
    if (!weatherEl) return;
    weatherEl.textContent = msg;
    weatherEl.style.color = "#e74c3c";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      weatherEl.style.color = "#ff6b6b";
    }
  }

  function getCachedWeather() {
    const cached = localStorage.getItem('weatherData');
    const cacheTime = localStorage.getItem('weatherCacheTime');
    if (cached && cacheTime && (Date.now() - cacheTime) < 9000000) {
      return JSON.parse(cached);
    }
    return null;
  }

  function setCachedWeather(data) {
    localStorage.setItem('weatherData', JSON.stringify(data));
    localStorage.setItem('weatherCacheTime', Date.now().toString());
  }

  let isWeatherFetching = false;
  async function getWeather() {
    if (isWeatherFetching) return;
    
    const cachedData = getCachedWeather();
    if (cachedData) {
      renderWeather(cachedData);
      return;
    }
    
    try {
      isWeatherFetching = true;
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ ${res.status}`);
      const data = await res.json();
      if (!data.city || !data.wea_img || !data.wea || !data.tem_night || !data.tem_day || !data.air || !data.win || !data.win_speed) {
        throw new Error("æ•°æ®ä¸å®Œæ•´");
      }
      setCachedWeather(data);
      renderWeather(data);
    } catch (err) {
      console.error("è·å–å¤©æ°”å¤±è´¥ï¼š", err);
      if (!cachedData) {
        renderWeatherError("è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥");
      }
    } finally {
      isWeatherFetching = false;
    }
  }

  let currentDate = new Date();  
  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const monthYearElement = document.getElementById('calendar-month-year');
    if (monthYearElement) {
      monthYearElement.textContent = `${year}å¹´${month + 1}æœˆ`;
    }
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();
    const firstDayIndex = firstDay.getDay();
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    const datesElement = document.getElementById('calendar-dates');
    if (!datesElement) return;
    datesElement.innerHTML = '';
    
    for (let i = firstDayIndex; i > 0; i--) {
      const day = prevMonthLastDay - i + 1;
      const dateElement = document.createElement('div');
      dateElement.classList.add('other-month', 'date-item');
      dateElement.textContent = day;
      datesElement.appendChild(dateElement);
    }
    
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const dateElement = document.createElement('div');
      dateElement.classList.add('current-month', 'date-item');
      dateElement.textContent = i;
      if (
        year === today.getFullYear() &&
        month === today.getMonth() &&
        i === today.getDate()
      ) {
        dateElement.classList.add('today');
      }
      datesElement.appendChild(dateElement);
    }
    
    const totalCells = 42;
    const nextMonthDays = totalCells - (firstDayIndex + lastDay.getDate());
    for (let i = 1; i <= nextMonthDays; i++) {
      const dateElement = document.createElement('div');
      dateElement.classList.add('other-month', 'date-item');
      dateElement.textContent = i;
      datesElement.appendChild(dateElement);
    }
  }

  function adaptThemeColors() {
    const root = document.documentElement;
    const computedStyle = getComputedStyle(root);
    const primaryColor = computedStyle.getPropertyValue('--primary-color').trim() || '#3a86ff';
    const cardBg = computedStyle.getPropertyValue('--card-bg').trim() || '#ffffff';
    const textColor = computedStyle.getPropertyValue('--text-color').trim() || '#333333';
    const borderColor = computedStyle.getPropertyValue('--border-color').trim() || '#eaeaea';
    const secondaryTextColor = computedStyle.getPropertyValue('--secondary-text-color').trim() || '#666666';
    const hoverBg = computedStyle.getPropertyValue('--hover-bg').trim() || '#f5f5f5';
    const widget = document.querySelector('.custom-sidebar-widget');
    if (widget) {
      widget.style.setProperty('--primary-color', primaryColor);
      widget.style.setProperty('--card-bg', cardBg);
      widget.style.setProperty('--text-color', textColor);
      widget.style.setProperty('--border-color', borderColor);
      widget.style.setProperty('--secondary-text-color', secondaryTextColor);
      widget.style.setProperty('--hover-bg', hoverBg);
      const rgb = hexToRgb(primaryColor);
      if (rgb) {
        widget.style.setProperty('--primary-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
      }
    }
  }

  function watchThemeChange() {
    const darkModeMedia = window.matchMedia('(prefers-color-scheme: dark)');
    darkModeMedia.addEventListener('change', adaptThemeColors);
    document.addEventListener('theme-change', adaptThemeColors);
  }

  function hexToRgb(hex) {
    let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
      return r + r + g + g + b + b;
    });
    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  updateTime();
  updateDate();
  renderCalendar(currentDate);
  adaptThemeColors();
  watchThemeChange();

  const timeInterval = setInterval(updateTime, 1000);
  const dateInterval = setInterval(updateDate, 60000);
  const weatherInterval = setInterval(getWeather, 2.5 * 60 * 60 * 1000);
  
  window.calendarTimers.push(timeInterval, dateInterval, weatherInterval);

  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  
  if (prevMonthBtn) {
    const newPrevBtn = prevMonthBtn.cloneNode(true);
    prevMonthBtn.parentNode.replaceChild(newPrevBtn, prevMonthBtn);
    
    newPrevBtn.addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });
  }
  
  if (nextMonthBtn) {
    const newNextBtn = nextMonthBtn.cloneNode(true);
    nextMonthBtn.parentNode.replaceChild(newNextBtn, nextMonthBtn);
    
    newNextBtn.addEventListener('click', function() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });
  }

  if (!window.weatherFetchTimer) {
    const cachedWeather = getCachedWeather();
    if (cachedWeather) {
      renderWeather(cachedWeather);
    } else {
      window.weatherFetchTimer = setTimeout(() => {
        getWeather();
        window.weatherFetchTimer = null;
      }, 500);
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  let initTimer = null;
  function safeInit() {
    if (initTimer) clearTimeout(initTimer);
    initTimer = setTimeout(initCalendarWidget, 100);
  }
  
  safeInit();
  document.addEventListener('rd.pjax.complete', safeInit);
  
  const observer = new MutationObserver(function(mutations) {
    const hasCachedWeather = !!localStorage.getItem('weatherData') && (Date.now() - localStorage.getItem('weatherCacheTime')) < 9000000;
    let needInit = false;
    
    for (const mutation of mutations) {
      if (mutation.type === 'childList') {
        const widget = document.querySelector('.custom-sidebar-widget');
        if (widget) {
          const timeEl = widget.querySelector('#current-time');
          const weatherEl = widget.querySelector('#current-weather');
          
          if ((!timeEl || timeEl.textContent === '') || 
              (weatherEl && weatherEl.textContent === 'åŠ è½½ä¸­...' && !hasCachedWeather)) {
            needInit = true;
            break;
          }
        }
      }
    }
    
    if (needInit) {
      safeInit();
    }
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});
</script>